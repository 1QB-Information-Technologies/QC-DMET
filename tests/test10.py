'''
    QC-DMET: a python implementation of density matrix embedding theory for ab initio quantum chemistry
    Copyright (C) 2015 Sebastian Wouters
    
    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.
    
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
    
    You should have received a copy of the GNU General Public License along
    with this program; if not, write to the Free Software Foundation, Inc.,
    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
'''

import sys
sys.path.append('../src')
import localintegrals, dmet
from pyscf import gto, scf, symm
import numpy as np

mol = gto.Mole() # C28H100 optimized with psi4 B3LYP/6-31G
mol.atom = '''
           C          0.425650813633    -0.641357119718     0.000000000000
           H          1.086823749341    -0.637862257879     0.880346345019
           H          1.086823749341    -0.637862257879    -0.880346345019
           C         -0.425650813633     0.641357119718     0.000000000000
           H         -1.086823749341     0.637862257879     0.880346345019
           H         -1.086823749341     0.637862257879    -0.880346345019
           C          0.412046922354     1.932999133686     0.000000000000
           H          1.073219580186     1.936495613569     0.880346491467
           H          1.073219580186     1.936495613569    -0.880346491467
           C         -0.412046922354    -1.932999133686     0.000000000000
           H         -1.073219580186    -1.936495613569     0.880346491467
           H         -1.073219580186    -1.936495613569    -0.880346491467
           C          0.439257443549    -3.215711988189     0.000000000000
           H          1.100430080700    -3.212214361571     0.880346508639
           H          1.100430080700    -3.212214361571    -0.880346508639
           C         -0.439257443549     3.215711988189     0.000000000000
           H         -1.100430080700     3.212214361571     0.880346508639
           H         -1.100430080700     3.212214361571    -0.880346508639
           C         -0.398435990255    -4.507357177737     0.000000000000
           H         -1.059607787113    -4.510858205760     0.880346877685
           H         -1.059607787113    -4.510858205760    -0.880346877685
           C          0.398435990255     4.507357177737     0.000000000000
           H          1.059607787113     4.510858205760     0.880346877685
           H          1.059607787113     4.510858205760    -0.880346877685
           C          0.452877056940    -5.790065625588     0.000000000000
           H          1.114049238720    -5.786563831801     0.880346698710
           H          1.114049238720    -5.786563831801    -0.880346698710
           C         -0.452877056940     5.790065625588     0.000000000000
           H         -1.114049238720     5.786563831801     0.880346698710
           H         -1.114049238720     5.786563831801    -0.880346698710
           C          0.384806032558     7.081716713560     0.000000000000
           H          1.045977873063     7.085220562268     0.880346885937
           H          1.045977873063     7.085220562268    -0.880346885937
           C         -0.384806032558    -7.081716713560     0.000000000000
           H         -1.045977873063    -7.085220562268     0.880346885937
           H         -1.045977873063    -7.085220562268    -0.880346885937
           C         -0.466518977958     8.364417423170     0.000000000000
           H         -1.127691186112     8.360910297473     0.880346696177
           H         -1.127691186112     8.360910297473    -0.880346696177
           C          0.466518977958    -8.364417423170     0.000000000000
           H          1.127691186112    -8.360910297473     0.880346696177
           H          1.127691186112    -8.360910297473    -0.880346696177
           C         -0.371151251524    -9.656077439592     0.000000000000
           H         -1.032322886522    -9.659588614917     0.880346967174
           H         -1.032322886522    -9.659588614917    -0.880346967174
           C          0.371151251524     9.656077439592     0.000000000000
           H          1.032322886522     9.659588614917     0.880346967174
           H          1.032322886522     9.659588614917    -0.880346967174
           C          0.480188602116   -10.938767491221     0.000000000000
           H          1.141361155932   -10.935251076433     0.880346504659
           H          1.141361155932   -10.935251076433    -0.880346504659
           C         -0.480188602116    10.938767491221     0.000000000000
           H         -1.141361155932    10.935251076433     0.880346504659
           H         -1.141361155932    10.935251076433    -0.880346504659
           C         -0.357464305323   -12.230438545713     0.000000000000
           H         -1.018636126439   -12.233959279909     0.880346842443
           H         -1.018636126439   -12.233959279909    -0.880346842443
           C          0.357464305323    12.230438545713     0.000000000000
           H          1.018636126439    12.233959279909     0.880346842443
           H          1.018636126439    12.233959279909    -0.880346842443
           C          0.493894169068   -13.513116057659     0.000000000000
           H          1.155066751627   -13.509590470475     0.880346446215
           H          1.155066751627   -13.509590470475    -0.880346446215
           C         -0.493894169068    13.513116057659     0.000000000000
           H         -1.155066751627    13.509590470475     0.880346446215
           H         -1.155066751627    13.509590470475    -0.880346446215
           C         -0.343738502354   -14.804799800004     0.000000000000
           H         -1.004909971854   -14.808330465749     0.880346941149
           H         -1.004909971854   -14.808330465749    -0.880346941149
           C          0.343738502354    14.804799800004     0.000000000000
           H          1.004909971854    14.808330465749     0.880346941149
           H          1.004909971854    14.808330465749    -0.880346941149
           C          0.507641743567   -16.087463402465     0.000000000000
           H          1.168814225548   -16.083926420475     0.880346448012
           H          1.168814225548   -16.083926420475    -0.880346448012
           C         -0.507641743567    16.087463402465     0.000000000000
           H         -1.168814225548    16.083926420475     0.880346448012
           H         -1.168814225548    16.083926420475    -0.880346448012
           C         -0.329968909771   -17.379160672021     0.000000000000
           H         -0.991140269927   -17.382702788555     0.880346895767
           H         -0.991140269927   -17.382702788555    -0.880346895767
           C          0.329968909771    17.379160672021     0.000000000000
           H          0.991140269927    17.382702788555     0.880346895767
           H          0.991140269927    17.382702788555    -0.880346895767
           C          0.521433895821   -18.661809308161     0.000000000000
           H          1.182605970696   -18.658260923101     0.880346596941
           H          1.182605970696   -18.658260923101    -0.880346596941
           C         -0.521433895821    18.661809308161     0.000000000000
           H         -1.182605970696    18.658260923101     0.880346596941
           H         -1.182605970696    18.658260923101    -0.880346596941
           C         -0.316155637546   -19.953519898192     0.000000000000
           H         -0.977326366049   -19.957073229657     0.880347008121
           H         -0.977326366049   -19.957073229657    -0.880347008121
           C          0.316155637546    19.953519898192     0.000000000000
           H          0.977326366049    19.957073229657     0.880347008121
           H          0.977326366049    19.957073229657    -0.880347008121
           C          0.535270033578   -21.236152954162     0.000000000000
           H          1.196441022224   -21.232593551254     0.880346979834
           H          1.196441022224   -21.232593551254    -0.880346979834
           C         -0.535270033578    21.236152954162     0.000000000000
           H         -1.196441022224    21.232593551254     0.880346979834
           H         -1.196441022224    21.232593551254    -0.880346979834
           C         -0.302301548697   -22.527874754622     0.000000000000
           H         -0.963470333473   -22.531438303360     0.880347463541
           H         -0.963470333473   -22.531438303360    -0.880347463541
           C          0.302301548697    22.527874754622     0.000000000000
           H          0.963470333473    22.531438303360     0.880347463541
           H          0.963470333473    22.531438303360    -0.880347463541
           C          0.549147261988   -23.810489839871     0.000000000000
           H          1.210315560571   -23.806921955117     0.880349029611
           H          1.210315560571   -23.806921955117    -0.880349029611
           C         -0.549147261988    23.810489839871     0.000000000000
           H         -1.210315560571    23.806921955117     0.880349029611
           H         -1.210315560571    23.806921955117    -0.880349029611
           C         -0.288427264484   -25.102208612936     0.000000000000
           H         -0.949589971844   -25.105775245984     0.880341448989
           H         -0.949589971844   -25.105775245984    -0.880341448989
           C          0.288427264484    25.102208612936     0.000000000000
           H          0.949589971844    25.105775245984     0.880341448989
           H          0.949589971844    25.105775245984    -0.880341448989
           C          0.563003426499   -26.384864175226     0.000000000000
           H          1.224190835576   -26.381221023207     0.880367561942
           H          1.224190835576   -26.381221023207    -0.880367561942
           C         -0.563003426499    26.384864175226     0.000000000000
           H         -1.224190835576    26.381221023207     0.880367561942
           H         -1.224190835576    26.381221023207    -0.880367561942
           C         -0.274219782770   -27.676657526681     0.000000000000
           H         -0.935533331155   -27.681474159705     0.880357701559
           H         -0.935533331155   -27.681474159705    -0.880357701559
           C          0.274219782770    27.676657526681     0.000000000000
           H          0.935533331155    27.681474159705     0.880357701559
           H          0.935533331155    27.681474159705    -0.880357701559
           C          0.577114512764   -28.959745710248     0.000000000000
           H          1.237791342518   -28.954269194986     0.879625419332
           H          1.237791342518   -28.954269194986    -0.879625419332
           C         -0.577114512764    28.959745710248     0.000000000000
           H         -1.237791342518    28.954269194986     0.879625419332
           H         -1.237791342518    28.954269194986    -0.879625419332
           C         -0.266918357480   -30.244387683277     0.000000000000
           H         -0.913364629626   -30.291129457225     0.885544571977
           H         -0.913364629626   -30.291129457225    -0.885544571977
           H          0.365600883012   -31.139762135872     0.000000000000
           C          0.266918357480    30.244387683277     0.000000000000
           H          0.913364629626    30.291129457225     0.885544571977
           H          0.913364629626    30.291129457225    -0.885544571977
           H         -0.365600883012    31.139762135872     0.000000000000
  '''
mol.basis = 'sto-3g'
mol.symmetry = 0
mol.charge = 0
mol.spin = 0 #2*S; multiplicity-1
mol.build()

mf = scf.RHF( mol )
mf.verbose = 4
mf.scf()

myInts = localintegrals.localintegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
myInts.molden( 'C48H100.molden' )

unit_sizes = 7 * np.ones( [ 48 ], dtype=int ) # 48xCH2
unit_sizes[0] = unit_sizes[47] = 8 # CH3 at the ends
assert( np.sum( unit_sizes ) == mol.nao_nr() )

carbons_in_cluster = 1
units_counter = 0
orbitals_counter = 0

impurityClusters = []
while ( units_counter < len( unit_sizes ) ):
    impurities = np.zeros( [ mol.nao_nr() ], dtype=int )
    for unit in range( units_counter, min( len( unit_sizes ), units_counter + carbons_in_cluster ) ):
        impurities[ orbitals_counter : orbitals_counter + unit_sizes[ unit ] ] = 1
        orbitals_counter += unit_sizes[ unit ]
    units_counter += carbons_in_cluster
    impurityClusters.append( impurities )

totalcount = np.zeros( [ mol.nao_nr() ], dtype=int )
for item in impurityClusters:
    totalcount += item
assert ( np.linalg.norm( totalcount - np.ones( [ mol.nao_nr() ], dtype=float ) ) < 1e-12 )

isTranslationInvariant = False
method = 'CC'
theDMET = dmet.dmet( myInts, impurityClusters, isTranslationInvariant, method )
theDMET.doselfconsistent()


